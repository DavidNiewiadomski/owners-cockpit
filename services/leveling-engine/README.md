# Leveling Engine Service\n\nA Node.js service that performs statistical analysis and outlier detection on construction bid data using Tukey's IQR method.\n\n## Overview\n\nThe Leveling Engine is part of the post-RFP process and provides:\n\n- **Statistical Analysis**: Groups bid line items by description + CSI code\n- **Outlier Detection**: Uses Tukey's IQR method with configurable thresholds\n- **Allowance Normalization**: Automatically identifies and separates allowance items\n- **Automated Processing**: Nightly cron jobs to refresh leveling data\n- **Event Publishing**: Publishes `bid.leveling.completed` events\n\n## Features\n\n### Core Algorithm\n1. **Data Grouping**: Groups bid line items by `description + CSI code`\n2. **Null Handling**: Fills NULL values with 0\n3. **Vendor Calculations**: Computes `vendor_base_bid = Σ extended`\n4. **Allowance Processing**: Subtracts allowances from base bid totals\n5. **Outlier Detection**: Flags outliers using `>1.5*IQR` threshold\n6. **Matrix Generation**: Creates JSON matrix with all analysis results\n\n### API Endpoints\n- `POST /api/rfp/{id}/level` - Perform leveling analysis\n- `GET /api/rfp/{id}/level` - Get latest leveling results\n- `GET /api/rfp/needing-leveling` - List RFPs needing analysis\n- `POST /api/process-pending` - Process all pending RFPs\n- `GET /health` - Health check\n\n### Automation\n- **Nightly Cron Job**: Automatically processes RFPs until award\n- **Configurable Schedule**: Default runs at 2 AM UTC\n- **Batch Processing**: Handles multiple RFPs concurrently\n- **Timeout Protection**: Prevents long-running analyses\n\n## Installation\n\n### Prerequisites\n- Node.js 18+\n- Supabase database access\n- npm or yarn\n\n### Setup\n\n1. **Install Dependencies**\n   ```bash\n   cd services/leveling-engine\n   npm install\n   ```\n\n2. **Environment Configuration**\n   ```bash\n   cp .env.example .env\n   # Edit .env with your configuration\n   ```\n\n3. **Database Migration**\n   ```bash\n   # Run the leveling snapshot migration\n   supabase migration apply 20250702230000_create_leveling_snapshot_table\n   ```\n\n## Usage\n\n### Start the Service\n\n```bash\n# Development\nnpm run dev\n\n# Production\nnpm start\n```\n\n### API Examples\n\n#### Perform Leveling Analysis\n\n```bash\ncurl -X POST \"http://localhost:3001/api/rfp/550e8400-e29b-41d4-a716-446655440000/level\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"forceRefresh\": false,\n    \"outlierThreshold\": 1.5,\n    \"options\": {\n      \"includeDetails\": true\n    }\n  }'\n```\n\n#### Get Latest Analysis\n\n```bash\ncurl \"http://localhost:3001/api/rfp/550e8400-e29b-41d4-a716-446655440000/level\"\n```\n\n## Algorithm Details\n\n### Tukey's IQR Method\n\nThe service uses Tukey's Interquartile Range method for outlier detection:\n\n1. **Calculate Quartiles**: Q1 (25th percentile), Q3 (75th percentile)\n2. **Compute IQR**: `IQR = Q3 - Q1`\n3. **Set Boundaries**: \n   - Lower bound: `Q1 - (1.5 * IQR)`\n   - Upper bound: `Q3 + (1.5 * IQR)`\n4. **Flag Outliers**: Values outside boundaries\n5. **Severity Classification**:\n   - **Mild**: 1.5 - 3.0 × IQR\n   - **Moderate**: 3.0 - 4.5 × IQR\n   - **Severe**: > 4.5 × IQR\n\n### Allowance Processing\n\nThe system automatically identifies allowance items:\n\n```javascript\nfunction isAllowanceItem(description) {\n  const lowerDesc = description.toLowerCase()\n  return lowerDesc.includes('allowance') || \n         lowerDesc.includes('contingency') ||\n         lowerDesc.includes('reserve')\n}\n```\n\nAllowance amounts are:\n- Subtracted from vendor base totals\n- Tracked separately in the analysis\n- Included in detailed reporting\n\n### Data Grouping\n\nLine items are grouped using:\n\n```javascript\nconst groupKey = `${csiCode}:${description.toLowerCase().trim()}`\n```\n\nThis ensures:\n- Items with same description and CSI code are analyzed together\n- Case-insensitive matching\n- Consistent grouping across vendors\n\n## Integration\n\n### With Document Extractor\n\nThe leveling engine processes data extracted by the doc-extractor service:\n\n1. Documents uploaded → S3 trigger → doc-extractor\n2. Extracted data stored in `bid_line_item` tables\n3. Leveling engine processes grouped line items\n4. Results stored in `leveling_snapshot` table\n\n### Event Publishing\n\nOn completion, publishes `bid.leveling.completed` event:\n\n```json\n{\n  \"eventType\": \"bid.leveling.completed\",\n  \"rfpId\": \"uuid\",\n  \"snapshotId\": \"uuid\",\n  \"analysisDate\": \"2025-07-02T21:45:10Z\",\n  \"outlierCount\": 8,\n  \"vendorCount\": 5\n}\n```\n\n### Agent Operating Rules Compliance\n\nFollows Agent Operating Rules:\n\n- **Credential Handling**: Environment variables only\n- **Error Handling**: Comprehensive logging and recovery\n- **Performance**: Configurable timeouts and concurrency\n- **Monitoring**: Health checks and metrics\n\n## License\n\nThis project is part of the Owners Cockpit platform."
