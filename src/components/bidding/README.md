# LevelingBoard Component\n\nA React component for displaying bid leveling analysis with interactive outlier detection and clarification requests.\n\n## Overview\n\nThe `LevelingBoard` component is a sophisticated table that displays construction bid data in a matrix format, highlighting outliers and providing tools for analysis and vendor communication.\n\n## Features\n\n### Visual Layout\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Line Item     â”‚ Vendor Aâ”‚ Vendor B â”‚ Vendor C â”‚ Adjusted Base   â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ 03-300 Concreteâ”‚$1,200K â”‚$1,180K  âš â”‚$1,900K  ğŸ”ºâ”‚ Vendor A: $1.2M â”‚\nâ”‚ Placement     â”‚         â”‚          â”‚          â”‚ Vendor B: $1.18Mâ”‚\nâ”‚               â”‚         â”‚          â”‚          â”‚ Vendor C: $1.9M â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ 05-120 Struct â”‚ $890K   â”‚ $850K    â”‚ $920K    â”‚ Vendor A: $890K â”‚\nâ”‚ Steel         â”‚         â”‚          â”‚          â”‚ Vendor B: $850K â”‚\nâ”‚               â”‚         â”‚          â”‚          â”‚ Vendor C: $920K â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Key Features\n\n- **ğŸ”º Outlier Detection**: Visual flags for statistical outliers\n- **âš ï¸ Missing Data**: Clear indication of missing vendor data\n- **ğŸ’° Auto-calculated Totals**: Adjusted base bid column with allowance handling\n- **ğŸ“Š Interactive Selection**: Click to select items for clarification\n- **ğŸ“¤ Excel Export**: One-click export with summary statistics\n- **ğŸ¤– Clarification Bot**: Automated vendor inquiry generation\n\n## Installation\n\n### Required Dependencies\n\nAdd these packages to your project:\n\n```bash\nnpm install @tanstack/react-table @tanstack/react-query xlsx\n```\n\n### Optional Dependencies (if not already installed)\n\n```bash\nnpm install lucide-react sonner\n```\n\n## Usage\n\n### Basic Usage\n\n```tsx\nimport { LevelingBoard } from '@/components/bidding';\n\nfunction BidEvaluationPage({ rfpId }: { rfpId: string }) {\n  return (\n    <div>\n      <h1>Bid Evaluation</h1>\n      <LevelingBoard rfpId={rfpId} />\n    </div>\n  );\n}\n```\n\n### With Custom Styling\n\n```tsx\n<LevelingBoard \n  rfpId={rfpId}\n  className=\"my-8 border-2 border-gray-200\"\n/>\n```\n\n### Complete Example\n\nSee `LevelingBoardExample.tsx` for a comprehensive implementation.\n\n## Props\n\n| Prop | Type | Required | Description |\n|------|------|----------|-------------|\n| `rfpId` | `string` | Yes | UUID of the RFP to analyze |\n| `className` | `string` | No | Additional CSS classes |\n\n## Data Flow\n\n1. **Data Source**: Fetches from `/leveling_snapshot` via `useLevelingSnapshot` hook\n2. **Processing**: Uses leveling engine service for real-time analysis\n3. **Display**: Renders matrix with react-table\n4. **Export**: Generates Excel files with XLSX library\n5. **Clarification**: Sends requests to clarification bot service\n\n## Outlier Detection\n\n### Tukey's IQR Method\n\nThe component uses statistical outlier detection:\n\n- **Mild Outliers**: 1.5 Ã— IQR â—\n- **Moderate Outliers**: 2.0 Ã— IQR âš ï¸ \n- **Severe Outliers**: 3.0 Ã— IQR ğŸ”º/ğŸ”»\n\n### Color Coding\n\n- **Red**: High severe outliers (>+20%)\n- **Blue**: Low severe outliers (<-20%)\n- **Orange**: Moderate outliers\n- **Yellow**: Mild outliers\n- **Gray**: Missing data\n\n## Interactive Features\n\n### Cell Selection\n\n```tsx\n// Click any vendor cell to select for clarification\n// Multiple selections supported\nconst [selectedCells, setSelectedCells] = useState<Set<string>>(new Set());\n```\n\n### Allowance Toggle\n\n```tsx\n// Control visibility of allowance items\nconst [includeAllowances, setIncludeAllowances] = useState(true);\n```\n\n### Search and Filter\n\n```tsx\n// Global search across all line items\nconst [globalFilter, setGlobalFilter] = useState('');\n```\n\n## Export Features\n\n### Excel Export Structure\n\n**Sheet 1: Leveling Analysis**\n- All line items with vendor pricing\n- Outlier annotations\n- Statistical measures (median, mean, IQR)\n\n**Sheet 2: Summary**\n- Total outlier count and percentage\n- Vendor count and base bid statistics\n- Analysis metadata\n\n### Export Code\n\n```tsx\nconst handleExportToExcel = () => {\n  const exportData = snapshot.matrixData.map(item => {\n    // Transform data for Excel\n    const row = {\n      'CSI Code': item.csiCode,\n      'Description': item.description,\n      // ... vendor columns\n    };\n    return row;\n  });\n  \n  const worksheet = XLSX.utils.json_to_sheet(exportData);\n  const workbook = XLSX.utils.book_new();\n  XLSX.utils.book_append_sheet(workbook, worksheet, 'Leveling Analysis');\n  XLSX.writeFile(workbook, `Leveling_Analysis_${rfpId}.xlsx`);\n};\n```\n\n## Clarification Workflow\n\n### Request Generation\n\n1. User selects problematic cells\n2. Component analyzes selected items\n3. Generates structured clarification request\n4. Sends to clarification bot service\n\n### Request Format\n\n```typescript\ninterface ClarificationRequest {\n  rfpId: string;\n  flaggedItems: Array<{\n    groupKey: string;\n    description: string;\n    vendors: Array<{\n      vendorName: string;\n      issue: string; // \"Outlier detected: severe high\"\n      amount: number;\n    }>;\n  }>;\n}\n```\n\n## Service Integration\n\n### Leveling Engine Service\n\n```typescript\n// Connects to Node.js leveling engine\nconst response = await fetch(`${levelingServiceUrl}/api/rfp/${rfpId}/level`, {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({ forceRefresh, outlierThreshold })\n});\n```\n\n### Database Schema\n\nRequires `leveling_snapshot` table with:\n- `matrix_data`: JSONB column with analysis results\n- `summary_stats`: Aggregate statistics\n- `outlier_summary`: Outlier counts and classifications\n\n## Customization\n\n### Custom Outlier Thresholds\n\n```tsx\n// Adjust sensitivity of outlier detection\nconst levelingAnalysis = useLevelingAnalysis();\nlevelingAnalysis.mutate({\n  rfpId,\n  outlierThreshold: 2.0 // Default: 1.5\n});\n```\n\n### Custom Styling\n\n```css\n/* Target outlier cells */\n.outlier-severe {\n  @apply bg-red-100 text-red-800 border-red-300;\n}\n\n.outlier-moderate {\n  @apply bg-orange-100 text-orange-800 border-orange-300;\n}\n```\n\n### Custom Icons\n\n```tsx\nconst getOutlierIcon = (vendor: LevelingVendor): string => {\n  if (!vendor.isOutlier) return '';\n  \n  switch (vendor.outlierSeverity) {\n    case 'severe': return vendor.outlierType === 'high' ? 'ğŸ”º' : 'ğŸ”»';\n    case 'moderate': return 'âš ï¸';\n    case 'mild': return 'â—';\n    default: return '';\n  }\n};\n```\n\n## Performance\n\n### Optimization Features\n\n- **React Query Caching**: 5-minute stale time for snapshots\n- **Memoized Calculations**: Vendor totals and table data\n- **Virtual Scrolling**: Large datasets (optional)\n- **Debounced Search**: 300ms delay on filter input\n\n### Memory Management\n\n```tsx\n// Efficient data transformation\nconst tableData = useMemo((): TableRow[] => {\n  // Heavy computation only when data changes\n}, [snapshot, vendors, includeAllowances, selectedCells]);\n```\n\n## Error Handling\n\n### Loading States\n\n- **Loading**: Spinner with progress message\n- **Error**: Retry button with error details\n- **Empty**: Generate analysis call-to-action\n\n### Error Recovery\n\n```tsx\nif (error) {\n  return (\n    <Card>\n      <CardContent className=\"p-8\">\n        <AlertTriangle className=\"h-12 w-12 text-red-500 mx-auto\" />\n        <h3>Error Loading Leveling Data</h3>\n        <p>{error.message}</p>\n        <Button onClick={() => refetch()}>Try Again</Button>\n      </CardContent>\n    </Card>\n  );\n}\n```\n\n## Testing\n\n### Unit Tests\n\n```typescript\nimport { render, screen } from '@testing-library/react';\nimport { LevelingBoard } from './LevelingBoard';\n\ntest('renders leveling board with data', async () => {\n  render(<LevelingBoard rfpId=\"test-rfp-id\" />);\n  \n  expect(screen.getByText('Leveling Board')).toBeInTheDocument();\n  expect(screen.getByText('Export')).toBeInTheDocument();\n});\n```\n\n### Integration Tests\n\n```typescript\ntest('export functionality works', async () => {\n  const { user } = renderWithQueryClient(<LevelingBoard rfpId=\"test-id\" />);\n  \n  await user.click(screen.getByText('Export'));\n  \n  // Verify XLSX file generation\n  expect(mockXLSX.writeFile).toHaveBeenCalled();\n});\n```\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Missing Data**: Ensure leveling engine has processed the RFP\n2. **Excel Export Fails**: Check XLSX library installation\n3. **Outliers Not Showing**: Verify minimum 4 vendors per line item\n4. **Clarification Errors**: Check clarification service endpoint\n\n### Debug Mode\n\n```tsx\n// Enable detailed logging\nconst { data, isLoading, error } = useLevelingSnapshot(rfpId, {\n  onSuccess: (data) => console.log('Snapshot loaded:', data),\n  onError: (error) => console.error('Snapshot error:', error)\n});\n```\n\n## Dependencies\n\n- `@tanstack/react-table`: Table functionality\n- `@tanstack/react-query`: Data fetching and caching\n- `xlsx`: Excel export functionality\n- `sonner`: Toast notifications\n- `lucide-react`: Icons\n- Radix UI components (via shadcn/ui)\n\n## License\n\nPart of the Owners Cockpit platform."
